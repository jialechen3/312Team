<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Battlefield</title>
  <style>
    body {
      margin: 0;
      background-color: #121212;
    }
    canvas {
      display: block;
      margin: auto;
      background: #1e1e2f;
    }
  </style>
</head>
<body>
<canvas id="game" width="800" height="600"></canvas>

<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
<script>
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const socket = io();

  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get('room');
  if (!roomId) {
    alert("Room ID is missing in the URL.");
    throw new Error("Room ID not found");
  }

  const TILE_SIZE = 40;
  let playerId = null;
  let players = {};
  let pos = { x: 0, y: 0 };

  // Fetch username and start the game
  fetch('/api/whoami', {
  credentials: 'include'
})
    .then(res => res.json())
    .then(data => {
      if (data.username) {
        playerId = data.username;
        joinGame();
      } else {
        alert("Not authenticated");
        window.location.href = "/login";
      }
    });

  function joinGame() {
    socket.emit('join_room', { roomId, player: playerId });

    socket.on('player_positions', (playerList) => {
      players = {};
      playerList.forEach(p => {
        players[p.id] = { x: p.x, y: p.y };
      });
      draw();
    });

    document.addEventListener('keydown', handleMovement);

    draw(); // Initial draw
  }

  function handleMovement(e) {
    if (e.key === "ArrowUp") pos.y--;
    if (e.key === "ArrowDown") pos.y++;
    if (e.key === "ArrowLeft") pos.x--;
    if (e.key === "ArrowRight") pos.x++;

    pos.x = Math.max(0, Math.min(pos.x, canvas.width / TILE_SIZE - 1));
    pos.y = Math.max(0, Math.min(pos.y, canvas.height / TILE_SIZE - 1));

    socket.emit('move', {
      roomId: roomId,
      player: playerId,
      x: pos.x,
      y: pos.y
    });
  }

  function drawGrid() {
    ctx.strokeStyle = '#444';
    for (let x = 0; x < canvas.width; x += TILE_SIZE) {
      for (let y = 0; y < canvas.height; y += TILE_SIZE) {
        ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
      }
    }
  }

  function drawPlayers() {
    Object.keys(players).forEach((id) => {
      const { x, y } = players[id];
      ctx.fillStyle = id === playerId ? 'lime' : 'red';
      ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
      ctx.fillStyle = 'white';
      ctx.fillText(id, x * TILE_SIZE + 5, y * TILE_SIZE + 15);
    });
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawGrid();
    drawPlayers();
  }
</script>
</body>
</html>
