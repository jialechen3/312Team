<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Battlefield</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('/static/images/tag_battle_bg.png') no-repeat center -530px fixed;
      background-size: cover;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: crosshair;
    }

    canvas {
      background: #1e1e2f;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      z-index: 10;
      position: relative;
    }
  </style>
</head>
<body>
<div id="timer" style="
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 24px;
  font-weight: bold;
  color: white;
  text-shadow: 1px 1px 3px black;
  z-index: 20;
">
  00:00
</div>
<canvas id="game" width="1200" height="750"></canvas>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const socket = io('/battlefield', {
  query: { page: 'battlefield' }
});

const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get('room');
if (!roomId) {
  alert("Room ID is missing in the URL.");
  throw new Error("Room ID not found");
}

const TILE_SIZE = 40;
const MAP_WIDTH = 100;
const MAP_HEIGHT = 100;

const terrain = Array.from({ length: MAP_HEIGHT }, (_, y) =>
  Array.from({ length: MAP_WIDTH }, (_, x) => {
    if (y < 5 && x >= MAP_WIDTH - 5) {
      const insideX = x >= MAP_WIDTH - 4 && x <= MAP_WIDTH - 2;
      const insideY = y >= 1 && y <= 3;
      if (insideX && insideY) return 0;
      return 3;
    }
    if (y >= MAP_HEIGHT - 5 && x < 5) return 2;
    if ((x + y) % 17 === 0 && x > 5 && x < MAP_WIDTH - 6 && y > 5 && y < MAP_HEIGHT - 6) return 1;
    return 0;
  })
);

let playerId = null;
let players = {};
let deadPlayers = {};    // Tracks who is dead
let respawnTimers = {};  // Tracks how many seconds left to respawn
let pos = { x: 0, y: 0 };

// Handle player positions when received from server
socket.on('player_positions', (playerList) => {
  console.log("[SOCKET] Received player_positions:", playerList);

  players = {};
  playerList.forEach(p => {
    players[p.id] = { x: p.x, y: p.y, team: p.team };
  });

  if (players[playerId]) {
    pos = { x: players[playerId].x, y: players[playerId].y };
    console.log("[SOCKET] Centered camera on:", pos);
  }

  draw();
});

// New listener for tags
socket.on('player_tagged', ({ tagger, target }) => {
  console.log(`[TAG] ${tagger} tagged ${target}`);
  deadPlayers[target] = true;
  respawnTimers[target] = 5; // 5 second respawn

  const timer = setInterval(() => {
    respawnTimers[target]--;
    if (respawnTimers[target] <= 0) {
      clearInterval(timer);
      delete respawnTimers[target];
      deadPlayers[target] = false;
      console.log(`[RESPAWN TIMER DONE] ${target} is alive again (client side)`);

      // Optionally, request latest player info from server again (not critical if server sends `player_respawned`)
    }
  }, 1000);
});

// When a player respawns
socket.on('player_respawned', ({ playerId }) => {
  console.log(`[RESPAWN] ${playerId} is alive again`);
  deadPlayers[playerId] = false;
  delete respawnTimers[playerId];
  socket.emit('request_positions');
});

// Fetch player info and join game
fetch('/api/whoami', { credentials: 'include' })
  .then(res => res.json())
  .then(data => {
    if (data.username) {
      playerId = data.username;
      console.log("[JOIN GAME] Player ID:", playerId);
      joinGame();
    } else {
      alert("Not authenticated");
      window.location.href = "/login";
    }
  });

function joinGame() {
  console.log("[JOIN GAME] joinGame() called");

  socket.emit('join_room', {
    room_id: roomId,
    player: playerId
  });

  setInterval(draw, 1000 / 60);  // redraw every 16ms
}

// Emit move on key press
document.addEventListener('keydown', (e) => {
  if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
    const direction = e.key.replace('Arrow', '').toLowerCase();

    console.log("[SOCKET] Emitting move:", { direction: direction });
    socket.emit('move', {
      roomId: roomId,
      player: playerId,
      direction: direction
    });
  }
});

function drawGrid(viewX, viewY) {
  const cols = Math.ceil(canvas.width / TILE_SIZE);
  const rows = Math.ceil(canvas.height / TILE_SIZE);

  for (let x = 0; x < cols; x++) {
    for (let y = 0; y < rows; y++) {
      const worldX = Math.floor(viewX + x);
      const worldY = Math.floor(viewY + y);

      if (worldX < MAP_WIDTH && worldY < MAP_HEIGHT) {
        const tileType = terrain[worldY][worldX];
        switch (tileType) {
          case 1: ctx.fillStyle = 'gray'; break;
          case 2: ctx.fillStyle = 'blue'; break;
          case 3: ctx.fillStyle = 'red'; break;
          default: ctx.fillStyle = '#1e1e2f';
        }
        ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        ctx.strokeStyle = '#222';
        ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
      }
    }
  }
}

function drawPlayers(viewX, viewY) {
  for (const id in players) {
    const player = players[id];

    const screenX = (player.x - viewX) * TILE_SIZE;
    const screenY = (player.y - viewY) * TILE_SIZE;

    // Determine color
    if (deadPlayers[id]) {
      ctx.fillStyle = 'gray';  // Dead players are gray
    } else if (player.team === 'red') {
      ctx.fillStyle = 'red';
    } else if (player.team === 'blue') {
      ctx.fillStyle = 'blue';
    } else {
      ctx.fillStyle = 'gray';
    }

    const size = 35;

    // Highlight yourself differently
    if (id === playerId) {
      ctx.strokeStyle = 'gold';
      ctx.lineWidth = 3;
      ctx.strokeRect(screenX, screenY, size, size);
    }

    ctx.fillRect(screenX, screenY, size, size);

    // Write player ID
    ctx.fillStyle = 'white';
    ctx.font = '12px Arial';
    ctx.fillText(id, screenX, screenY - 5);

    // If dead, also show respawn timer
    if (deadPlayers[id]) {
      ctx.fillStyle = 'yellow';
      if (respawnTimers[id] !== undefined) {
        ctx.fillText(`Respawn: ${respawnTimers[id]}`, screenX, screenY + size + 10);
      } else {
        ctx.fillText("DEAD", screenX, screenY + size + 10);
      }
    }
  }
}


function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const tilesInViewX = canvas.width / TILE_SIZE;
  const tilesInViewY = canvas.height / TILE_SIZE;

  let viewX = pos.x - Math.floor(tilesInViewX / 2);
  let viewY = pos.y - Math.floor(tilesInViewY / 2);

  viewX = Math.max(0, Math.min(viewX, MAP_WIDTH - tilesInViewX));
  viewY = Math.max(0, Math.min(viewY, MAP_HEIGHT - tilesInViewY));

  drawGrid(viewX, viewY);
  drawPlayers(viewX, viewY);
}
</script>

</body>
</html>
